const fs = require("fs");
const dotenv = require("dotenv");
const { Telegraf } = require("telegraf");
const { initTestData, users } = require("./data/testData");

// Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ .env Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°)
if (fs.existsSync(".env")) {
  dotenv.config();
  console.log("ðŸ“„ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ .env Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½");
} else {
  console.log("ðŸŒ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Railway");
}

// Ð‘ÐµÑ€ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð¸Ð· process.env (ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð¾)
const BOT_TOKEN = process.env.BOT_TOKEN;

if (!BOT_TOKEN) {
  console.error("âŒ BOT_TOKEN Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ");
  process.exit(1);
}

// Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð±Ð¾Ñ‚Ð°
const bot = new Telegraf(BOT_TOKEN);

// Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
initTestData();

// Middleware Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
bot.use((ctx, next) => {
  const userId = ctx.from?.id;
  if (!userId) return next();

  if (!users.has(userId)) {
    users.set(userId, {
      id: userId,
      username: ctx.from.username ?? null,
      firstName: ctx.from.first_name ?? "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",
      isAuthenticated: false,
      role: "user",
    });
  }

  ctx.user = users.get(userId);
  return next();
});

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ñ…ÐµÐ½Ð´Ð»ÐµÑ€Ð¾Ð²
["auth", "menu", "products", "cart", "orders", "info", "pricelist"].forEach(
  (handler) => {
    try {
      require(`./handlers/${handler}`)(bot);
      console.log(`âœ… Handler ${handler} Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½`);
    } catch (err) {
      console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ handler ${handler}:`, err.message);
    }
  }
);

// Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð¾Ñ‚Ð°:", err);
  try {
    if (ctx.answerCbQuery) {
      ctx.answerCbQuery("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°");
    }
    ctx.reply("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");
  } catch (e) {
    console.error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ:", e);
  }
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
bot
  .launch()
  .then(() => {
    console.log("ðŸš€ Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!");
  })
  .catch((err) => {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°:", err);
    process.exit(1);
  });

// ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
